- name: Workaround for devstack installation in Newton or earlier
  shell:
    cmd: |
      # workaround for bug https://review.openstack.org/#/c/562610/
      sed -i '/"Running gate_hook"/ a\
          sed -i "s/strip/split/" /opt/stack/new/devstack/inc/python' '{{ ansible_user_dir }}/workspace/devstack-gate/devstack-vm-gate-wrap.sh'
    executable: /bin/bash
  ignore_errors: yes

- name: Install libpcre3-dev
  shell: |
    apt install libpcre3-dev -y
  ignore_errors: yes

- name: workaround devstack installation on stable/mitaka branch
  shell:
    cmd: |
      set -e
      set -x
      # Because the pip10 cannot uninstall/upgrade the pre-installed distutils packages
      # see: https://github.com/pypa/pip/issues/4805
      sed -i '/"Running gate_hook"/ a\
                sed -i "s/pip!=8/pip!=8,<10.0.0/" /opt/stack/new/devstack/tools/cap-pip.txt' '{{ ansible_user_dir }}/workspace/devstack-gate/devstack-vm-gate-wrap.sh'
      # Because in setuptools>=39, the pkg_resources.parse_version(oslo_utils/versionutils.py) will return an unindexable object
      pip install "setuptools==38.0.0"
    executable: /bin/bash
    chdir: '{{ ansible_user_dir }}/workspace'
  environment: '{{ zuul | zuul_legacy_vars }}'
  when:
    - os_branch == 'stable/mitaka'

- name: Install devstack on {{ os_branch }} branch
  shell:
    cmd: |
      set -e
      set -x
      export PYTHONUNBUFFERED=true
      export GIT_BASE=https://github.com
      export OVERRIDE_ZUUL_BRANCH='{{ os_branch }}'
      export DEVSTACK_GATE_NEUTRON=1
      export DEVSTACK_GATE_FIXED_RANGE=10.0.0.0/20
      export PROJECTS="openstack/designate $PROJECTS"
      export PROJECTS="openstack/python-manilaclient openstack/manila-tempest-plugin $PROJECTS"
      export PROJECTS="openstack/barbican openstack/python-barbicanclient $PROJECTS"
      export PROJECTS="openstack/devstack-plugin-container $PROJECTS"
      export PROJECTS="openstack/kuryr-libnetwork $PROJECTS"
      export PROJECTS="openstack/zun openstack/zun-tempest-plugin openstack/python-zunclient $PROJECTS"

      cp devstack-gate/devstack-vm-gate-wrap.sh ./safe-devstack-vm-gate-wrap.sh
      ./safe-devstack-vm-gate-wrap.sh

      # Enable snat
      eval $(grep FLOATING_RANGE /opt/stack/new/devstack/local.conf)
      iptables -t nat -A POSTROUTING -s "$FLOATING_RANGE" -o $(ip -4 route | grep ^default | awk '{print $5}') -j MASQUERADE

      # Delete all rules in chain openstack-INPUT to allow unlimited access from nested vm
      iptables -F openstack-INPUT || true
    executable: /bin/bash
    chdir: '{{ ansible_user_dir }}/workspace'
  environment: '{{ zuul | zuul_legacy_vars }}'
