# Shared jobs specific to the OpenLab Project

# Common test base job
- job:
    name: init-test
    description: |
      Base job for all types of test jobs. Ensure workspace and copy log files.
    pre-run: playbooks/init-test/pre.yaml
    post-run: playbooks/init-test/post.yaml
    timeout: 10800

# Golang test base job
- job:
    name: golang-test
    parent: init-test
    description: |
      Base job for all types of golang test jobs.
    pre-run: playbooks/golang-test/pre.yaml
    post-run: playbooks/golang-test/post.yaml
    vars:
      golang_env:
        GOPATH: '{{ ansible_user_dir }}'
        PATH: '{{ ansible_env.PATH }}:/usr/local/go/bin:{{ ansible_user_dir }}/bin'
        TEST_RESULTS_TXT: '{{ ansible_user_dir }}/workspace/test_results.txt'
        TEST_RESULTS_XML: '{{ ansible_user_dir }}/workspace/test_results.xml'
        TEST_RESULTS_HTML: '{{ ansible_user_dir }}/workspace/test_results.html'


# Gophercloud jobs
- job:
    name: gophercloud-unittest
    parent: golang-test
    description: |
      Run gophercloud unit test
    run: playbooks/gophercloud-unittest/run.yaml
    nodeset: ubuntu-xenial-ut

- job:
    name: gophercloud-acceptance-test
    parent: golang-test
    description: |
      Run gophercloud acceptance test on master branch
    run: playbooks/gophercloud-acceptance-test/run.yaml

- job:
    name: gophercloud-acceptance-test-pike
    parent: gophercloud-acceptance-test
    description: |
      Run gophercloud acceptance test on pike branch
    vars:
      os_branch: 'stable/pike'

- job:
    name: gophercloud-acceptance-test-ocata
    parent: gophercloud-acceptance-test
    description: |
      Run gophercloud acceptance test on ocata branch
    vars:
      os_branch: 'stable/ocata'

- job:
    name: gophercloud-acceptance-test-newton
    parent: gophercloud-acceptance-test
    description: |
      Run gophercloud acceptance test on newton branch
    vars:
      os_branch: 'stable/newton'

- job:
    name: gophercloud-acceptance-test-mitaka
    parent: gophercloud-acceptance-test
    description: |
      Run gophercloud acceptance test on mitaka branch
    vars:
      os_branch: 'stable/mitaka'
    nodeset: ubuntu-trusty

# Gophercloud acceptance tests with Telefonica cloud
- job:
    name: gophercloud-acceptance-test-telefonica
    parent: golang-test
    description: |
      Run gophercloud acceptance test against telefonica cloud
    run: playbooks/gophercloud-acceptance-test-telefonica/run.yaml

# Terraform-provider-openstack jobs
- job:
    name: terraform-provider-openstack-unittest
    parent: golang-test
    description: |
      Run terraform provider openstack unit test
    run: playbooks/terraform-provider-openstack-unittest/run.yaml
    nodeset: ubuntu-xenial-ut

- job:
    name: terraform-provider-openstack-acceptance-test
    parent: golang-test
    description: |
      Run terraform provider openstack acceptance test on master branch
    run: playbooks/terraform-provider-openstack-acceptance-test/run.yaml

- job:
    name: terraform-provider-openstack-acceptance-test-pike
    parent: terraform-provider-openstack-acceptance-test
    description: |
      Run terraform provider openstack acceptance test on pike branch
    vars:
      os_branch: 'stable/pike'

- job:
    name: terraform-provider-openstack-acceptance-test-ocata
    parent: terraform-provider-openstack-acceptance-test
    description: |
      Run terraform provider openstack acceptance test on ocata branch
    vars:
      os_branch: 'stable/ocata'

- job:
    name: terraform-provider-openstack-acceptance-test-newton
    parent: terraform-provider-openstack-acceptance-test
    description: |
      Run terraform provider openstack acceptance test on newton branch
    vars:
      os_branch: 'stable/newton'

- job:
    name: terraform-provider-openstack-acceptance-test-mitaka
    parent: terraform-provider-openstack-acceptance-test
    description: |
      Run terraform provider openstack acceptance test on mitaka branch
    vars:
      os_branch: 'stable/mitaka'
    nodeset: ubuntu-trusty

- job:
    name: terraform-provider-openstack-acceptance-test-designate
    parent: golang-test
    description: |
      Run terraform provider openstack designate acceptance test on master branch
    run: playbooks/terraform-provider-openstack-acceptance-test-designate/run.yaml

- job:
    name: terraform-provider-openstack-acceptance-test-trove
    parent: golang-test
    description: |
      Run terraform-provider-openstack trove acceptance test on master branch
    run: playbooks/terraform-provider-openstack-acceptance-test-trove/run.yaml

# Gophercloud acceptance tests with Telefonica cloud
- job:
    name: gophercloud-acceptance-test-telefonica
    parent: golang-test
    description: |
      Run gophercloud acceptance test against telefonica cloud
    run: playbooks/gophercloud-acceptance-test-telefonica/run.yaml


# terraform-provider-telefonicaopencloud acceptance tests with Telefonica cloud
- job:
    name: terraform-provider-telefonicaopencloud-acceptance-test-telefonica
    parent: golang-test
    description: |
      Run acceptance tests of terraform-provider-telefonicaopencloud repo against telefonica cloud
    run: playbooks/terraform-provider-telefonicaopencloud-acceptance-test-telefonica/run.yaml


# terraform-provider-flexibleengine acceptance tests with orange cloud
- job:
    name: terraform-provider-flexibleengine-acceptance-test-orange
    parent: golang-test
    description: |
      Run acceptance tests of terraform-provider-flexibleengine repo against orange cloud
    run: playbooks/terraform-provider-flexibleengine-acceptance-test-orange/run.yaml

# terraform-provider-opentelekomcloud acceptance tests with Telekom cloud
- job:
    name: terraform-provider-opentelekomcloud-acceptance-test-telekom
    parent: golang-test
    description: |
      Run acceptance tests of terraform-provider-opentelekomcloud repo against telekom cloud
    run: playbooks/terraform-provider-opentelekomcloud-acceptance-test-telekom/run.yaml
    secrets:
      - telekom_credentials

- job:
    name: openstack-cloud-controller-manager-unit-test
    parent: golang-test
    description: |
      Run K8S openstack-cloud-controller-manager unit test
    run: playbooks/openstack-cloud-controller-manager-unit-test/run.yaml

- job:
    name: openstack-cloud-controller-manager-kubeadm
    parent: golang-test
    description: |
      Enable openstack-cloud-controller-manager with kubeadm
    run: playbooks/openstack-cloud-controller-manager-kubeadm/run.yaml

- job:
    name: openstack-cloud-controller-manager-in-devstack
    parent: golang-test
    description: |
      Run K8S openstack-cloud-controller-manager unit test in devstack instance
    run: playbooks/openstack-cloud-controller-manager-in-devstack/run.yaml
    nodeset: ubuntu-xenial-large

- job:
    name: openstack-cloud-controller-manager-in-devstack-lbaas
    parent: golang-test
    description: |
      Run K8S openstack-cloud-controller-manager unit test in devstack instance against lbaas
    run: playbooks/openstack-cloud-controller-manager-in-devstack-lbaas/run.yaml
    nodeset: ubuntu-xenial-large

- job:
    name: openlab-zuul-jobs-check
    parent: init-test
    description: |
      This job runs against project-config, openlab-zuul-jobs and zuul-jobs
      so we can properly lint our ansible playbooks / roles
    required-projects:
      - liu-sheng/openlab-zuul-jobs
      - liu-sheng/project-config
      - liu-sheng/zuul-jobs
    run: playbooks/openlab-zuul-jobs-check/run.yaml
