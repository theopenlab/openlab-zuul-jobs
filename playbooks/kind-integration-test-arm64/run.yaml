---
- hosts: all
  become: yes
  roles:
    - role: config-golang
      go_version: 1.12.1
      arch: arm64
    - role: install-docker-ce
      arch: arm64
    #- role: andrewrothstein.bazel
    #  bazel_ver: '0.23.1'

  tasks:
    - name: get required repositories
      shell:
        cmd: |
          export GO111MODULE="on"
          go get -d -v sigs.k8s.io/kind@master
          go get -d -v k8s.io/kubernetes@master
          go get -u k8s.io/test-infra/kubetest
        executable: /bin/bash
      environment: '{{ global_env }}'

    - name: Create e2e directory for testgrid
      file:
        path: '{{ k8s_log_dir }}'
        state: directory

    - name: run e2e test
      shell:
        cmd: |
          export LOG_DIR='{{ k8s_log_dir }}'
          # Add a walk-around start time to the e2e.log file to make the
          # upload step running
          date +"%b %e %H:%M:%S.999: START " | tee $LOG_DIR/e2e.log
          cd $GOPATH/src/k8s.io/kubernetes && $GOPATH/src/sigs.k8s.io/kind/hack/ci/e2e.sh
          cp -R $GOPATH/src/k8s.io/kubernetes/_artifacts/* $LOG_DIR
        executable: /bin/bash
      environment: '{{ global_env }}'
