- import_playbook: common.yaml

# NOTE: elasticsearch can't be ran under root.
- hosts: all
  become: no
  tasks:
    # Todo(wxy): Frocksdb doesn't have ARM release. Build and install it locally currently.
    - name: Build and install frocksdb
      shell:
        cmd: |
          git clone https://github.com/dataArtisans/frocksdb.git
          cd frocksdb
          git checkout origin/FRocksDB-5.17.2
          sudo apt update
          sudo apt install -y gcc g++ make
          export DEBUG_LEVEL=0
          make -j8 rocksdbjava

          mvn install:install-file -DgroupId=com.data-artisans \
          -DartifactId=frocksdbjni -Dversion=5.17.2-artisans-1.0 \
          -Dpackaging=jar -Dfile=java/target/rocksdbjni-5.17.2-linux64.jar
      args:
        executable: /bin/bash
        chdir: '/home/zuul'
      environment: '{{ global_env }}'

    - name: Add git author info
      shell:
        cmd: |
          git config --global user.email "info@openlabtesting.org"
          git config --global user.name "OpenLab"
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'

    # TODO(wxy): Should fix in apache/flink
    - name: ARM hack changes
      shell:
        cmd: |
          set -xo pipefail

          cat << EOF >> arm_hack.patch
          From af7a1487dbfed257dcea0c89b528051e917afda3 Mon Sep 17 00:00:00 2001
          From: wangxiyuan <wangxiyuan@huawei.com>
          Date: Thu, 19 Sep 2019 15:20:51 +0800
          Subject: [PATCH] ARM Related Hack

          ---
           .../prometheus/tests/PrometheusReporterEndToEndITCase.java        | 2 +-
           tools/travis/nightly.sh                                           | 4 ++--
           2 files changed, 3 insertions(+), 3 deletions(-)

          diff --git a/flink-end-to-end-tests/flink-metrics-reporter-prometheus-test/src/test/java/org/apache/flink/metrics/prometheus/tests/PrometheusReporterEndToEndITCase.java b/flink-end-to-end-tests/flink-metrics-reporter-prometheus-test/src/test/java/org/apache/flink/metrics/prometheus/tests/PrometheusReporterEndToEndITCase.java
          index 258d293..eb3d635 100644
          --- a/flink-end-to-end-tests/flink-metrics-reporter-prometheus-test/src/test/java/org/apache/flink/metrics/prometheus/tests/PrometheusReporterEndToEndITCase.java
          +++ b/flink-end-to-end-tests/flink-metrics-reporter-prometheus-test/src/test/java/org/apache/flink/metrics/prometheus/tests/PrometheusReporterEndToEndITCase.java
          @@ -73,7 +73,7 @@ public class PrometheusReporterEndToEndITCase extends TestLogger {
           				PROMETHEUS_FILE_NAME = base + "windows-amd64";
           				break;
           			default:
          -				PROMETHEUS_FILE_NAME = base + "linux-amd64";
          +				PROMETHEUS_FILE_NAME = base + "linux-arm64";
           				break;
           		}
           	}
          diff --git a/tools/travis/nightly.sh b/tools/travis/nightly.sh
          index 0fb918e..5e75e8c 100755
          --- a/tools/travis/nightly.sh
          +++ b/tools/travis/nightly.sh
          @@ -27,8 +27,8 @@ fi

           SCRIPT=\$1

          -source \${HERE}/setup_docker.sh
          -source \${HERE}/setup_kubernetes.sh
          +# source \${HERE}/setup_docker.sh
          +# source \${HERE}/setup_kubernetes.sh

           ARTIFACTS_DIR="\${HERE}/artifacts"

          --
          2.7.4
          EOF

          git am arm_hack.patch
          rm arm_hack.patch
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'

    - name: Run split_misc.sh e2e test
      shell:
        cmd: |
          set -xo pipefail
          export PROFILE="-Dinclude-hadoop -Dhadoop.version=2.8.3 -De2e-metrics"

          ./tools/travis/nightly.sh split_misc.sh
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'

    - name: Run split_misc_hadoopfree.sh e2e test
      shell:
        cmd: |
          set -xo pipefail
          export PROFILE="-De2e-metrics"

          ./tools/travis/nightly.sh split_misc_hadoopfree.sh
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'
