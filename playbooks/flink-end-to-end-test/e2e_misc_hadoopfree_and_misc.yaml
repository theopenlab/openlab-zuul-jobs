# NOTE: elasticsearch can't be ran under root.
- hosts: all
  become: no
  tasks:
    - name: Create temp branch
      shell:
        cmd: |
          git pull
          git checkout -b e2e-test-arm
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'

    - name: Add git author info
      shell:
        cmd: |
          git config --global user.email "info@openlabtesting.org"
          git config --global user.name "OpenLab"
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'

    # TODO(wxy): Should fix in apache/flink
    - name: ARM hack changes
      shell:
        cmd: |
          set -xo pipefail

          cat << EOF >> arm_hack.patch
          From af7a1487dbfed257dcea0c89b528051e917afda3 Mon Sep 17 00:00:00 2001
          From: wangxiyuan <wangxiyuan@huawei.com>
          Date: Thu, 19 Sep 2019 15:20:51 +0800
          Subject: [PATCH] ARM Related Hack

          ---
           .../main/java/org/apache/flink/tests/util/CommandLineWrapper.java | 1 +
           .../prometheus/tests/PrometheusReporterEndToEndITCase.java        | 2 +-
           flink-end-to-end-tests/test-scripts/elasticsearch-common.sh       | 2 +-
           flink-end-to-end-tests/test-scripts/kafka-common.sh               | 2 +-
           tools/travis/nightly.sh                                           | 4 ++--
           5 files changed, 6 insertions(+), 5 deletions(-)

          diff --git a/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/CommandLineWrapper.java b/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/CommandLineWrapper.java
          index e9ee2e8..d668285 100644
          --- a/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/CommandLineWrapper.java
          +++ b/flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/CommandLineWrapper.java
          @@ -53,6 +53,7 @@ public enum CommandLineWrapper {
           			final List<String> commandsList = new ArrayList<>(5);
           			commandsList.add("wget");
           			commandsList.add("-q"); // silent
          +			commandsList.add("--no-check-certificate");
           			//commandsList.add("--show-progress"); // enable progress bar
           			if (targetDir != null) {
           				commandsList.add("-P");
          diff --git a/flink-end-to-end-tests/flink-metrics-reporter-prometheus-test/src/test/java/org/apache/flink/metrics/prometheus/tests/PrometheusReporterEndToEndITCase.java b/flink-end-to-end-tests/flink-metrics-reporter-prometheus-test/src/test/java/org/apache/flink/metrics/prometheus/tests/PrometheusReporterEndToEndITCase.java
          index 258d293..eb3d635 100644
          --- a/flink-end-to-end-tests/flink-metrics-reporter-prometheus-test/src/test/java/org/apache/flink/metrics/prometheus/tests/PrometheusReporterEndToEndITCase.java
          +++ b/flink-end-to-end-tests/flink-metrics-reporter-prometheus-test/src/test/java/org/apache/flink/metrics/prometheus/tests/PrometheusReporterEndToEndITCase.java
          @@ -73,7 +73,7 @@ public class PrometheusReporterEndToEndITCase extends TestLogger {
           				PROMETHEUS_FILE_NAME = base + "windows-amd64";
           				break;
           			default:
          -				PROMETHEUS_FILE_NAME = base + "linux-amd64";
          +				PROMETHEUS_FILE_NAME = base + "linux-arm64";
           				break;
           		}
           	}
          diff --git a/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh b/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh
          index 6959052..9c9c367 100644
          --- a/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh
          +++ b/flink-end-to-end-tests/test-scripts/elasticsearch-common.sh
          @@ -30,7 +30,7 @@ function setup_elasticsearch {

               # start downloading Elasticsearch
               echo "Downloading Elasticsearch from \$downloadUrl ..."
          -    curl "\$downloadUrl" > \$TEST_DATA_DIR/elasticsearch.tar.gz
          +    curl --insecure "\$downloadUrl" > \$TEST_DATA_DIR/elasticsearch.tar.gz

               local elasticsearchDir=\$TEST_DATA_DIR/elasticsearch
               mkdir -p \$elasticsearchDir
          diff --git a/flink-end-to-end-tests/test-scripts/kafka-common.sh b/flink-end-to-end-tests/test-scripts/kafka-common.sh
          index 96ac49b..cdb955b 100644
          --- a/flink-end-to-end-tests/test-scripts/kafka-common.sh
          +++ b/flink-end-to-end-tests/test-scripts/kafka-common.sh
          @@ -36,7 +36,7 @@ function setup_kafka_dist {
             mkdir -p \$TEST_DATA_DIR
             KAFKA_URL="https://archive.apache.org/dist/kafka/\$KAFKA_VERSION/kafka_2.11-\$KAFKA_VERSION.tgz"
             echo "Downloading Kafka from \$KAFKA_URL"
          -  curl "\$KAFKA_URL" --retry 10 --retry-max-time 120 > \$TEST_DATA_DIR/kafka.tgz
          +  curl --insecure "\$KAFKA_URL" --retry 10 --retry-max-time 120 > \$TEST_DATA_DIR/kafka.tgz

             tar xzf \$TEST_DATA_DIR/kafka.tgz -C \$TEST_DATA_DIR/

          diff --git a/tools/travis/nightly.sh b/tools/travis/nightly.sh
          index 0fb918e..5e75e8c 100755
          --- a/tools/travis/nightly.sh
          +++ b/tools/travis/nightly.sh
          @@ -27,8 +27,8 @@ fi

           SCRIPT=\$1

          -source \${HERE}/setup_docker.sh
          -source \${HERE}/setup_kubernetes.sh
          +# source \${HERE}/setup_docker.sh
          +# source \${HERE}/setup_kubernetes.sh

           ARTIFACTS_DIR="\${HERE}/artifacts"

          --
          2.7.4
          EOF

          git am arm_hack.patch
          rm arm_hack.patch
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'

- hosts: all
  become: yes
  tasks:
    - name: Get local hostname
      shell: hostname
      register: result
    - name: Hack package url dns
      lineinfile:
        path: "/etc/hosts"
        regexp: "^127.0.0.1"
        line: "127.0.0.1 {{ result.stdout }} localhost github.com download.elastic.co artifacts.elastic.co archive.apache.org"

- hosts: all
  become: no
  tasks:
    - name: Run split_misc.sh e2e test
      shell:
        cmd: |
          set -xo pipefail
          export PROFILE="-Dinclude-hadoop -Dhadoop.version=2.8.3 -De2e-metrics"

          ./tools/travis/nightly.sh split_misc.sh
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'

    - name: Run split_misc_hadoopfree.sh e2e test
      shell:
        cmd: |
          set -xo pipefail
          export PROFILE="-De2e-metrics"

          ./tools/travis/nightly.sh split_misc_hadoopfree.sh
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'
