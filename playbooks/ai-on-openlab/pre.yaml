- name: AI On Openlab Pre Job
  hosts: all
  become: yes
  tasks:
    - name: Get build id
      shell: echo '{{zuul.build}}' | cut -c 1-7
      register: build_id

'{{ ansible_user_dir }}/{{ zuul.project.src_dir }}/{{ user_file }}/framework_version.txt'

    - name: Get IP and Credential
      shell:
        cmd: |
          set -x
          set -e

          useradd demo -p 'demo'
          echo 'demo:demo' | chpasswd
          usermod -s /bin/bash demo
          mkdir /home/demo
          chown demo:demo /home/demo
          sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          service sshd restart

          if {{ env_keeping | lower }};then
            result_url=""
          else
            result_url="http://80.158.7.210/logs/{{ zuul.change }}/{{ zuul.change }}/{{ zuul.patchset }}/check/{{ zuul.job }}/{{ build_id.stdout }}/test_results/"
          fi

          cat > '{{ zuul.patchset }}.json' <<EOF
          {
            "ip": "{{ ansible_all_ipv4_addresses }}",
            "credentail": "demo/demo",
            "result_url": "$result_url",
            "endpoint": ""
          }
          EOF
        executable: /bin/bash

    - name: Upload Environment Info to Web
      shell:
        cmd: |
          apt install -y python-pip
          pip install pygithub

          source_file=`ls "{{ ansible_user_dir }}/{{ zuul.project.src_dir }}/{{ user_file }}/" | grep moo-job`
          dest_file=$(echo $source_file | cut -d . -f1)
          mv "{{ zuul.patchset }}.json" $dest_file.json
          cat > 'upload_env_info.py' <<EOF
          import github
          import sys

          file_name = sys.argv[1]

          github_obj = github.Github('moo-ai', 'mooopenlab1')
          repo = github_obj.get_user().get_repo('moo-ai.github.io')
          try:
              repo.get_file_contents('env_info/$dest_file.json')
          except github.UnknownObjectException:
              with open(file_name, 'rb') as env_info:
                  data = env_info.read()
                  repo.create_file(path='env_info/' + file_name,
                                   message='Upload env info',
                                   content=data,
                                   branch='master')
          EOF

          python upload_env_info.py '{{ zuul.patchset }}.json'
          curl -L "https://github.com/moo-ai/moo-ai.github.io/raw/master/env_info/{{ zuul.patchset }}.json"
        executable: /bin/bash

    - name: debug var
      debug:
        msg="hostvars ======= {{ hostvars }}"